!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).IsoImage=r()}(this,function(){"use strict";Object.assign||(Object.assign=function(t){for(var r=[],e=1;e<arguments.length;e++)r[e-1]=arguments[e];for(var n,o=Object(t),i=Object.prototype.hasOwnProperty,a=0,s=r.length;a<s;a++)for(var l in n=Object(r[a]))i.call(n,l)&&(o[l]=n[l]);return o});var t=Math.max,r=Math.min,e=Math.abs,n=Math.floor;function o(t){return t=Number(t),isNaN(t)?0:0===t||t===1/0||t===-1/0?t:(t<0?-1:1)*n(e(t))}Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.mean=function(){var t,r;for(t=0,r=0;t<this.length;t++)r+=this[t];return r/this.length},Array.prototype.fill=function(e){var n=arguments[1],i=arguments[2],a=function(t){if(null==t)throw TypeError();return Object(t)}(this),s=function(t){var e=o(t);return e<=0?0:e===1/0?9007199254740991:r(e,9007199254740991)}(a.length);s=t(s,0);var l,h,u,c=o(n);for(l=c<0?t(s+c,0):r(c,s),u=(h=void 0===i?s:o(i))<0?t(s+h,0):r(h,s);l<u;){a[String(l)]=e,l+=1}return a},Array.prototype.rep=function(t){return Array.apply(null,new Array(t)).map(Number.prototype.valueOf,this[0])},Array.prototype.pip=function(t,r){var e,n,o=!1;for(e=0,n=this.length-1;e<this.length;n=e++)this[e][1]>r!=this[n][1]>r&&t<(this[n][0]-this[e][0])*(r-this[e][1])/(this[n][1]-this[e][1])+this[e][0]&&(o=!o);return o};var i=function(){var t={},r=function(t,r){var e,n=new Array(r*r).fill(0);for(e=0;e<r;e++)n[e*r+e]=t;return n},e=function(t,r,e,n){var o,i,a=Array(e*n);for(o=0;o<e;o++)for(i=0;i<n;i++)a[o*n+i]=t[o*n+i]+r[o*n+i];return a},n=function(t,r,e,n,o){var i,a,s,l=Array(e*o);for(i=0;i<e;i++)for(a=0;a<o;a++)for(l[i*o+a]=0,s=0;s<n;s++)l[i*o+a]+=t[i*n+s]*r[s*o+a];return l},o=function(t,r){var e,n,o,i=Array(r);for(e=0;e<r;e++)i[e]=t[e*r+e];for(e=0;e<r;e++){for(n=0;n<e;n++)i[e]-=t[e*r+n]*t[e*r+n];if(i[e]<=0)return!1;for(i[e]=Math.sqrt(i[e]),n=e+1;n<r;n++){for(o=0;o<e;o++)t[n*r+e]-=t[n*r+o]*t[e*r+o];t[n*r+e]/=i[e]}}for(e=0;e<r;e++)t[e*r+e]=i[e];return!0},i=function(t,r){var e,n,o,i;for(e=0;e<r;e++)for(t[e*r+e]=1/t[e*r+e],n=e+1;n<r;n++){for(i=0,o=e;o<n;o++)i-=t[n*r+o]*t[o*r+e];t[n*r+e]=i/t[n*r+n]}for(e=0;e<r;e++)for(n=e+1;n<r;n++)t[e*r+n]=0;for(e=0;e<r;e++){for(t[e*r+e]*=t[e*r+e],o=e+1;o<r;o++)t[e*r+e]+=t[o*r+e]*t[o*r+e];for(n=e+1;n<r;n++)for(o=n;o<r;o++)t[e*r+n]+=t[o*r+e]*t[o*r+n]}for(e=0;e<r;e++)for(n=0;n<e;n++)t[e*r+n]=t[n*r+e]},a=function(t,r){var e,n,o,i,a,s,l,h,u,c,f,p=r,g=Array(r*r),v=Array(r),d=Array(r),y=Array(r);for(e=0;e<r;e++)for(i=0;i<r;i++)g[e*r+i]=e==i?1:0;for(i=0;i<r;i++)y[i]=0;for(e=0;e<r;e++){for(h=0,i=0;i<r;i++)if(1!=y[i])for(a=0;a<r;a++)0==y[a]&&Math.abs(t[i*r+a])>=h&&(h=Math.abs(t[i*r+a]),o=i,n=a);if(++y[n],o!=n){for(s=0;s<r;s++)f=t[o*r+s],t[o*r+s]=t[n*r+s],t[n*r+s]=f;for(s=0;s<p;s++)f=g[o*r+s],g[o*r+s]=g[n*r+s],g[n*r+s]=f}if(d[e]=o,v[e]=n,0==t[n*r+n])return!1;for(c=1/t[n*r+n],t[n*r+n]=1,s=0;s<r;s++)t[n*r+s]*=c;for(s=0;s<p;s++)g[n*r+s]*=c;for(l=0;l<r;l++)if(l!=n){for(u=t[l*r+n],t[l*r+n]=0,s=0;s<r;s++)t[l*r+s]-=t[n*r+s]*u;for(s=0;s<p;s++)g[l*r+s]-=g[n*r+s]*u}}for(s=r-1;s>=0;s--)if(d[s]!=v[s])for(a=0;a<r;a++)f=t[a*r+d[s]],t[a*r+d[s]]=t[a*r+v[s]],t[a*r+v[s]]=f;return!0},s=function(t,r,e,n,o){return r+(n-r)/e*(1-Math.exp(-1/o*Math.pow(t/e,2)))},l=function(t,r,e,n,o){return r+(n-r)/e*(1-Math.exp(-1/o*(t/e)))},h=function(t,r,e,n,o){return t>e?r+(n-r)/e:r+(n-r)/e*(t/e*1.5-.5*Math.pow(t/e,3))};return t.train=function(t,u,c,f,p,g){var v={t:t,x:u,y:c,nugget:0,range:0,sill:0,A:1/3,n:0};switch(f){case"gaussian":v.model=s;break;case"exponential":v.model=l;break;case"spherical":v.model=h}var d,y,m,w,b=t.length,x=Array((b*b-b)/2);for(d=0,m=0;d<b;d++)for(y=0;y<d;y++,m++)x[m]=Array(2),x[m][0]=Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),x[m][1]=Math.abs(t[d]-t[y]);x.sort(function(t,r){return t[0]-r[0]}),v.range=x[(b*b-b)/2-1][0];var M=(b*b-b)/2>30?30:(b*b-b)/2,E=v.range/M,A=new Array(M).fill(0),L=new Array(M).fill(0);if(M<30)for(w=0;w<M;w++)A[w]=x[w][0],L[w]=x[w][1];else{for(d=0,y=0,m=0,w=0;d<M&&y<(b*b-b)/2;d++,m=0){for(;x[y][0]<=(d+1)*E&&(A[w]+=x[y][0],L[w]+=x[y][1],m++,!(++y>=(b*b-b)/2)););m>0&&(A[w]/=m,L[w]/=m,w++)}if(w<2)return v}b=w,v.range=A[b-1]-A[0];var S=new Array(2*b).fill(1),_=Array(b),k=v.A;for(d=0;d<b;d++){switch(f){case"gaussian":S[2*d+1]=1-Math.exp(-1/k*Math.pow(A[d]/v.range,2));break;case"exponential":S[2*d+1]=1-Math.exp(-1/k*A[d]/v.range);break;case"spherical":S[2*d+1]=A[d]/v.range*1.5-.5*Math.pow(A[d]/v.range,3)}_[d]=L[d]}var C=function(t,r,e){var n,o,i=Array(e*r);for(n=0;n<r;n++)for(o=0;o<e;o++)i[o*r+n]=t[n*e+o];return i}(S,b,2),P=n(C,S,2,b,2),O=(P=e(P,r(1/g,2),2,2)).slice(0);o(P,2)?i(P,2):(a(O,2),P=O);var z=n(n(P,C,2,2,b),_,2,b,1);v.nugget=z[0],v.sill=z[1]*v.range+v.nugget,v.n=u.length,b=u.length;var T=Array(b*b);for(d=0;d<b;d++){for(y=0;y<d;y++)T[d*b+y]=v.model(Math.pow(Math.pow(u[d]-u[y],2)+Math.pow(c[d]-c[y],2),.5),v.nugget,v.range,v.sill,v.A),T[y*b+d]=T[d*b+y];T[d*b+d]=v.model(0,v.nugget,v.range,v.sill,v.A)}var I=e(T,r(p,b),b,b),R=I.slice(0);o(I,b)?i(I,b):(a(R,b),I=R);T=I.slice(0);var N=n(I,t,b,b,1);return v.K=T,v.M=N,v},t.predict=function(t,r,e){var o,i=Array(e.n);for(o=0;o<e.n;o++)i[o]=e.model(Math.pow(Math.pow(t-e.x[o],2)+Math.pow(r-e.y[o],2),.5),e.nugget,e.range,e.sill,e.A);return n(i,e.M,1,e.n,1)[0]},t}(),a=function(t,r){for(var e=t[0],n=t[1],o=!1,i=0,a=r.length-1;i<r.length;a=i++){var s=r[i][0],l=r[i][1],h=r[a][0],u=r[a][1];l>n!=u>n&&e<(h-s)*(n-l)/(u-l)+s&&(o=!o)}return o},s=Object.prototype.toString,l=function(t){return"[object Array]"===s.call(t)},h=function(t){return"[object Object]"===s.call(t)},u=function(t,r){if(r)return JSON.parse(JSON.stringify(t));if(l(t)){if(0==t.length||t.length>0&&!l(t[0])&&!h(t[0]))return Object.assign([],t,[]);for(var e=[],n=0,o=t.length;n<o;n++)e.push(u(t[n]));return e}if(h(t)){var i=new Object;for(var a in t)i[a]=u(t[a]);return i}return t},c=function(t,r){return t[0]==r[0]&&t[1]==r[1]},f=function(t,r,e,n,o,i,a){a=a||[];for(var s,l,h,p,g=n[n.length-1],v="t"==o||"b"==o?0:1,d="t"==o||"l"==o?1:-1,y=i?-1:1,m=0;e[o][m];m++){var w=e[o][m],b=(w.p[v]-g[v])*d*y;b>0&&(!s||s&&l>b)&&(s=w,l=b)}if(s)c(s.p,n[0])?n.push(s.p):(p=u(t[s.coor].coor),s.d&&p.reverse(),n=n.concat(p)),h=s.t;else if(i)switch(o){case"t":n.push(r.sa),h="l";break;case"r":n.push(r.sb),h="t";break;case"b":n.push(r.sc),h="r";break;case"l":n.push(r.sd),h="b"}else switch(o){case"t":n.push(r.sb),h="r";break;case"r":n.push(r.sc),h="b";break;case"b":n.push(r.sd),h="l";break;case"l":n.push(r.sa),h="t"}return n.length>1&&c(n[0],n[n.length-1])?[n].concat(a):(s&&p&&(a=f(t,r,e,p,h,!i,a)),f(t,r,e,n,h,i,a))},p=function(t,r,e){for(var n=!1,o=0,i=t.length;o<i;o++){if(r<t[o].value){if(!n){n=JSON.parse(JSON.stringify(t[o]));break}var a=(r-n.value)/(t[o].value-n.value),s=function(r){return e?n[r]+(t[o][r]-n[r])*a:t[o][r]};n.r=s("r"),n.g=s("g"),n.b=s("b"),n.a=s("a");break}n=JSON.parse(JSON.stringify(t[o]))}return n},g=Math.abs,v=Math.max,d=Math.min,y=Math.floor,m=function(t,r){for(var e,n,o=-1,i=1/0,a=[Math.abs(r[0]-r[2])/10,Math.abs(r[1]-r[3])/10],s=0;s<4;s++){var l=(e=r[s],n=t[s%2],Math.abs(e-n));l<a[s%2]&&l<i&&(i=l,o=s)}return!(o<0)&&"lbrt".charAt(o)},w=function(t){for(let r in t){let e=t[r];for(let t=0,n=e.length;t<n;t++){let o=e[t];if(o.t!=r)continue;let i="t"==r||"b"==r?0:1;for(let t=0;t<n;t++){let r=e[t];o.coor!=r.coor&&o.d==r.d&&(o.p[i]==r.p[i]&&(o.p[i]+=.1*(r.end[i]-o.end[i])),o.end[i]==r.end[i]&&(o.end[i]+=.1*(r.p[i]-o.p[i])))}}}return t};function b(t,r,e,n){for(var o,i=[],s=[],l={t:[],b:[],l:[],r:[]},h=t.features,b=0,x=h.length;b<x;b++)for(var M=h[b],E=0,A=(X=M.geometry.coordinates).length;E<A;E++){var L=X[E],S=L[0],_=L[L.length-1];if(c(S,_))i.push({coor:L,properties:M.properties,child:[],parent:[],i:i.length});else{s.push({coor:L,properties:M.properties});var k=m(S,r),C=m(_,r);if(!k||!C)continue;l[k].push({p:S,end:_,d:0,t:C,coor:s.length-1}),l[C].push({p:_,end:S,d:1,t:k,coor:s.length-1})}}var P={sa:[r[0],r[3]],sb:[r[2],r[3]],sc:[r[2],r[1]],sd:[r[0],r[1]]};l=w(l);b=0;for(var O=(o=f(s,P,l,[P.sa],"t",!1)).length;b<O;b++)i.push({coor:o[b],properties:{type:"open"},child:[],parent:[],i:i.length});for(b=0,x=i.length;b<x;b++)for(var z=b+1;z<x;z++){var T=i[b].properties.type,I=i[z].properties.type;"open"!=T&&a(i[b].coor[0],i[z].coor)?(i[z].child.push(b),i[b].parent.push(z)):"open"!=I&&a(i[z].coor[0],i[b].coor)&&(i[b].child.push(z),i[z].parent.push(b))}var R=u(i),N=[],j=[],F=[],q=function(){if(!R.length)return!1;for(var t=[],r=0,e=R.length;r<e;r++){for(var n=R[r],o=n.child,i=1,a=o.length-1;a>-1;a--)-1==j.indexOf(o[a])&&(i=0);if(i){var s=[];for(a=o.length-1;a>-1;a--){var l=F.indexOf(o[a]);l>-1&&(s.push(o[a]),F.splice(l,1))}F.push(n.i),j.push(n.i),R[r].child=s,N.push(R[r])}else t.push(R[r])}if(!t.length)return!1;R=t,q()};q();var G=[],U=e.features,B=U.length,W=U[0].geometry.coordinates,D=1,J=1,V=1;for(b=0;b<B;b++){var Y=U[b].geometry.coordinates;if(1==b&&(V=g(Y[1]-W[1])),Y[0]!=W[0]){D=b,J=g(Y[0]-W[0]);break}}for(b=0,x=N.length;b<x;b++){for(var X,H=[(X=N[b]).coor],K="rgba(0, 0, 0, 0)",Q=(z=0,X.child.length);z<Q;z++)H.push(i[X.child[z]].coor);var Z,$=y(X.coor.length/2),tt=X.coor[$],rt=(tt[0]-W[0])/J,et=v(y(rt)*D+y((tt[1]-W[1])/V),0),nt=rt%1?0:1,ot=nt?1:D,it=nt?V:J,at=it/100;if(U[et]&&U[et+ot]){var st=U[et].geometry.coordinates,lt=U[et+ot].geometry.coordinates,ht=Object.assign([],tt,[]);ht[nt]=v(tt[nt]-at,st[nt]);var ut=U[et].properties.val,ct=U[et+ot].properties.val;a(ht,X.coor)||(ht[nt]=d(tt[nt]+2*at,lt[nt])),a(ht,X.coor)&&(Z=ut+(ct-ut)*(g(ht[nt]-U[et].geometry.coordinates[nt])/it))}else U[et]&&(Z=U[et].properties.val);if(null!=Z){var ft=p(n,Z,!1);K="rgba("+ft.r+","+ft.g+","+ft.b+","+ft.a+")",Z=ft.value}G.push({geometry:{coordinates:H,type:"MultiLineString"},properties:{val:Z,color:K},type:"Feature"})}return{features:G,type:"FeatureCollection"}}var x=function(t,r,e){this.x=t||0,this.y=r||0,this.z=e||0};x.prototype={constructor:x,add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},subVectors:function(t,r){return this.x=t.x-r.x,this.y=t.y-r.y,this.z=t.z-r.z,this},distanceToSquared:function(t){var r=this.x-t.x,e=this.y-t.y;return r*r+e*e+(t=this.z-t.z)*t}};var M=function(){var t=function(){};t.prototype={getPoint:function(){return console.log("Warning, getPoint() not implemented!"),null},getPointAt:function(t){return t=this.getUtoTmapping(t),this.getPoint(t)},getPoints:function(t){var r;t||(t=5);var e=[];for(r=0;r<=t;r++)e.push(this.getPoint(r/t));return e},getSpacedPoints:function(t){var r;t||(t=5);var e=[];for(r=0;r<=t;r++)e.push(this.getPointAt(r/t));return e},getLength:function(){var t=this.getLengths();return t[t.length-1]},getLengths:function(t){if(t||(t=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length==t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var r,e,n=[],o=this.getPoint(0),i=0;for(n.push(0),e=1;e<=t;e++)i+=(r=this.getPoint(e/t)).distanceTo(o),n.push(i),o=r;return this.cacheArcLengths=n},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(t,r){var e,n=this.getLengths(),o=0,i=n.length;e=r||t*n[i-1];for(var a,s=0,l=i-1;s<=l;)if(0>(a=n[o=Math.floor(s+(l-s)/2)]-e))s=o+1;else{if(!(0<a)){l=o;break}l=o-1}return n[o=l]==e?o/(i-1):(o+(e-(s=n[o]))/(n[o+1]-s))/(i-1)},getTangent:function(t){var r=t-1e-4;return 0>r&&(r=0),1<(t=t+1e-4)&&(t=1),r=this.getPoint(r),this.getPoint(t).clone().sub(r).normalize()},getTangentAt:function(t){return t=this.getUtoTmapping(t),this.getTangent(t)}},t.Utils={tangentQuadraticBezier:function(t,r,e,n){return 2*(1-t)*(e-r)+2*t*(n-e)},tangentCubicBezier:function(t,r,e,n,o){return-3*r*(1-t)*(1-t)+3*e*(1-t)*(1-t)-6*t*e*(1-t)+6*t*n*(1-t)-3*t*t*n+3*t*t*o},tangentSpline:function(t){return 6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t)},interpolate:function(t,r,e,n,o){var i=o*o;return(2*r-2*e+(t=.5*(e-t))+(n=.5*(n-r)))*o*i+(-3*r+3*e-2*t-n)*i+t*o+r}},t.create=function(r,e){return r.prototype=Object.create(t.prototype),r.prototype.getPoint=e,r};var r=function(){};r.prototype={init:function(t,r,e,n){this.c0=t,this.c1=e,this.c2=-3*t+3*r-2*e-n,this.c3=2*t-2*r+e+n},initNonuniformCatmullRom:function(t,r,e,n,o,i,a){var s=(r-t)/o-(e-t)/(o+i)+(e-r)/i,l=(e-r)/i-(n-r)/(i+a)+(n-e)/a;s*=i,l*=i,this.init(r,e,s,l)},initCatmullRom:function(t,r,e,n,o){this.init(r,e,o*(e-t),o*(n-r))},calc:function(t){var r=t*t,e=r*t;return this.c0+this.c1*t+this.c2*r+this.c3*e}};var e=new x,n=new r,o=new r,i=new r;return t.create(function(t){this.points=t||[],this.closed=!1},function(t){var r,a,s,l,h,u,c,f=this.points,p=f.length;if(p<2&&console.log("duh, you need at least 2 points"),s=(r=(p-(this.closed?0:1))*t)-(a=Math.floor(r)),this.closed?a+=a>0?0:(Math.floor(Math.abs(a)/f.length)+1)*f.length:0===s&&a===p-1&&(a=p-2,s=1),this.closed||a>0?l=f[(a-1)%p]:(e.subVectors(f[0],f[1]).add(f[0]),l=e),h=f[a%p],u=f[(a+1)%p],this.closed||a+2<p?c=f[(a+2)%p]:(e.subVectors(f[p-1],f[p-2]).add(f[p-1]),c=e),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var g="chordal"===this.type?.5:.25,v=Math.pow(l.distanceToSquared(h),g),d=Math.pow(h.distanceToSquared(u),g),y=Math.pow(u.distanceToSquared(c),g);d<1e-4&&(d=1),v<1e-4&&(v=d),y<1e-4&&(y=d),n.initNonuniformCatmullRom(l.x,h.x,u.x,c.x,v,d,y),o.initNonuniformCatmullRom(l.y,h.y,u.y,c.y,v,d,y),i.initNonuniformCatmullRom(l.z,h.z,u.z,c.z,v,d,y)}else if("catmullrom"===this.type){var m=void 0!==this.tension?this.tension:.5;n.initCatmullRom(l.x,h.x,u.x,c.x,m),o.initCatmullRom(l.y,h.y,u.y,c.y,m),i.initCatmullRom(l.z,h.z,u.z,c.z,m)}return new x(n.calc(s),o.calc(s),i.calc(s))})}(),E=function(t,r){for(var e=new Array,n=0;n<t.length;n++)e[n]=new x(t[n][0],t[n][1],0);var o=new M(e).getPoints(r*e.length),i=new Array;for(n=0;n<o.length;n++)i.push([o[n].x,o[n].y]);return i},A={direction:"vertical",backgroundColor:"#fff",color:"#333",gradient:!0};function S(t,r){if(t.legend<2)return!1;var e=(r=Object.assign({},A,r)).gradient?1:0,n="horizontal"==r.direction?0:1,o=r.title||"",i=r.shape||"rect",a=document.createElement("canvas"),s=n?120:340;e||(s+=20);var l=n?240:50;a.width=s,a.height=l;var h=n?[15,30,20,200]:[70,5,200,20],u=n?[h[0],h[1]+h[3],h[0],h[1]]:[h[0],h[1],h[0]+h[2],h[1]],c=a.getContext("2d");c.lineWidth=1,c.strokeStyle="#999",c.fillStyle=r.backgroundColor,c.fillRect(0,0,s,l),c.font="12px 微软雅黑",c.textBaseline="middle",c.textAlign="start",c.fillStyle=r.color;for(var f=c.createLinearGradient(u[0],u[1],u[2],u[3]),p=0,g=t.length;p<g;p++){var v=t[p].color,d=t[p].unit||"",y=t[p].value+d,m=1/(g-1)*p;if(!e&&p>0&&p<g-1){var w=t[p-1].color;f.addColorStop(m,w),f.addColorStop(m,v)}else f.addColorStop(m,v);if(n)c.fillText(y,h[0]+h[2]+5,h[1]+h[3]*(1-m));else if(!p||p==g-1){var b=c.measureText(y).width,x=h[1]+h[3]/2,M=p?h[0]+h[2]+5:h[0]-5-b;c.fillText(y,M,x)}}switch(c.fillStyle=f,i){case"triangle-rect":if(n){var E=h[2]/2;c.beginPath(),c.moveTo(h[0]+E,h[1]),c.lineTo(h[0]+h[2],h[1]+E),c.lineTo(h[0]+h[2],h[1]+h[3]-E),c.lineTo(h[0]+E,h[1]+h[3]),c.lineTo(h[0],h[1]+h[3]-E),c.lineTo(h[0],h[1]+E),c.lineTo(h[0]+E,h[1]),c.stroke(),c.fill()}else{E=h[3]/2;c.beginPath(),c.moveTo(h[0],h[1]+E),c.lineTo(h[0]+E,h[1]),c.lineTo(h[0]+h[2]-E,h[1]),c.lineTo(h[0]+h[2],h[1]+E),c.lineTo(h[0]+h[2]-E,h[1]+h[3]),c.lineTo(h[0]+E,h[1]+h[3]),c.lineTo(h[0],h[1]+E),c.stroke(),c.fill()}break;default:c.fillRect(h[0],h[1],h[2],h[3])}return o.length&&(c.font="14px 微软雅黑",c.fillStyle=r.color,c.textBaseline="top",n?(c.textAlign="start",c.fillText(o,5,5)):(c.textAlign="center",c.fillText(o,s/2,h[1]+h[3]+5))),a}function _(t){t=t||{};var r=this.option,e=this.isoline,n=r.size,o=r.ex,i=r.text,a=t.width||1e3,s=Math.abs(a/n[0]*n[1]),l=t.isolineColor||"#333",h=t.filter,u=document.createElement("canvas");u.width=a,u.height=s;var c=u.getContext("2d");c.clearRect(0,0,a,s),c.lineWidth=1,c.font="12px 微软雅黑",c.textBaseline="middle",c.textAlign="center";for(var f=e.features,p={},g=0,v=f.length;g<v;g++){var d=f[g].properties.val;if(!h||!h.indexOf||-1!=h.indexOf(d)){var y=f[g].geometry.coordinates,m="level"==l?f[g].properties.color:l;c.strokeStyle=c.fillStyle=m;for(var w=0,b=y.length;w<b;w++){c.beginPath();for(var x=0,M=0,E=y[w].length;M<E;M++){var A=(y[w][M][0]-o[0][0])/n[0]*a,L=(y[w][M][1]-o[0][1])/n[1]*s;c[M?"lineTo":"moveTo"](A,L);var S=Math.round(A/16)+"-"+Math.round(L/16);!i||p[S]||x||(p[S]=1,x=1,c.fillText(d,A,L))}c.stroke()}}}return u}function k(t){var r=null==(t=t||{}).gradient?1:t.gradient,e=this.option,n=this.pointGrid,o=this.isosurface,i=e.size,a=e.cellWidth,s=e.level,l=e.ex,h=t.filter,u=t.width||1e3,c=Math.abs(u/i[0]*i[1]);if(r&&this.isosurfaceWebgl)return h&&this.isosurfaceWebgl.setFilter(h),this.isosurfaceWebgl.render(t);var f=document.createElement("canvas");f.width=u,f.height=c;var g=f.getContext("2d");if(g.clearRect(0,0,u,c),r)for(var v=n.features,d=i[0]/a>1?v[Math.abs(Math.ceil(i[1]/a))+1].geometry.coordinates[0]-v[0].geometry.coordinates[0]:a,y=i[1]/a>1?v[1].geometry.coordinates[1]-v[0].geometry.coordinates[1]:a,m=Math.abs(d/i[0]*u),w=Math.abs(y/i[1]*c),b=0,x=v.length;b<x;b++){var M=v[b].geometry.coordinates,E=(M[0]-l[0][0])/i[0]*u-m/2,A=(M[1]-l[0][1])/i[1]*c-w/2,L=p(s,v[b].properties.val,r),S=L.value;h&&h.indexOf&&-1==h.indexOf(S)||(g.strokeStyle=g.fillStyle="rgba("+L.r+","+L.g+","+L.b+","+L.a+")",g.beginPath(),g.fillRect(E-1,A-1,m+2,w+2))}else{var _=o.features;for(b=0,x=_.length;b<x;b++){S=_[b].properties.val;if(!h||!h.indexOf||-1!=h.indexOf(S)){var k=_[b].geometry.coordinates;g.strokeStyle=g.fillStyle=_[b].properties.color,g.beginPath();for(var C=0,P=k.length;C<P;C++)for(var O=0,z=k[C].length;O<z;O++){E=(k[C][O][0]-l[0][0])/i[0]*u,A=(k[C][O][1]-l[0][1])/i[1]*c;g[O?"lineTo":"moveTo"](E,A)}g.fill("evenodd")}}}return f}var C=function(t,r,e){var n=t.createShader(e);if(t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){var o=t.getShaderInfoLog(n);throw new Error("着色器程序构建失败！ \n\n"+o)}return n},P=function(t,r){var e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e);var n=new Float32Array(r);return t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW),e},O=function(t,r,e){try{t.bindBuffer(t.ARRAY_BUFFER,this[r]);var n=t.getAttribLocation(this.program,r);t.vertexAttribPointer(n,e,t.FLOAT,!1,0,0),t.enableVertexAttribArray(n)}catch(t){console.warn(t)}};function z(t,r,e){var n=document.createElement("canvas");n.width=1e3,n.height=1e3;var o=n.getContext("webgl");if(!o)return console.log("未发现 webgl !"),!1;this.canvas=n,this.gl=o,this.extent=t,this.grid=r,this.level=e,this.size=[t[1][0]-t[0][0],t[1][1]-t[0][1]],this.setup(o)}function T(t,r,e){if(!t[0])return!1;var n=(e=e||{}).opacity||1,o=t[0].width,i=t[0].height,a=document.createElement("canvas");a.width=o,a.height=i;var s=a.getContext("2d");s.clearRect(0,0,o,i),s.globalAlpha=n,s.strokeStyle=e.clipColor||"#333",s.lineWidth=e.clipWidth||1;var h=r.clip;if(h&&l(h)){var u=r.ex,c=r.size,f=r.key||{},p=f.clipX||0,g=f.clipY||1;s.beginPath();var v=function(t){if(l(t[0])&&l(t[0][0])){for(var r=0,e=t.length;r<e;r++)v(t[r]);return!1}if(l(t))for(r=0,e=t.length;r<e;r++){var n=(t[r][p]-u[0][0])/c[0]*o,a=(t[r][g]-u[0][1])/c[1]*i;s[r?"lineTo":"moveTo"](n,a)}};v(h),e.clip&&s.stroke(),s.clip()}for(var d=0;t[d];d++){var y=s.createPattern(t[d],"no-repeat");s.fillStyle=y,s.fillRect(0,0,o,i)}return a}z.prototype={state:null,canvas:null,gl:null,extent:[0,0,1,1],grid:null,level:null,program:null,indices:[],a_Position:null,a_Color:null,a_indices:null,u_Scale:null,u_Offset:null,constructor:z,setup:function(t){this.initShaders(t),this.initData(t)},initShaders:function(t){this.program=function(t,r,e){var n=C(t,r,t.VERTEX_SHADER),o=C(t,e,t.FRAGMENT_SHADER),i=t.createProgram();return t.attachShader(i,n),t.attachShader(i,o),t.linkProgram(i),t.useProgram(i),i}(t,"\n        attribute vec2 a_Position;\n        attribute vec4 a_Color;\n\n        uniform vec2 u_Scale;\n        uniform vec2 u_Offset;\n        \n        varying vec4 aColor;\n\n        void main() {\n          \n          aColor = a_Color;\n          // aColor = vec4(a_Position, 0.0, 1.0);\n\n          gl_Position = vec4((a_Position + u_Offset) * u_Scale, 0.0, 1.0);\n\n        }\n      ","\n        precision highp float;\n\n        varying vec4 aColor;\n\n        void main() {\n\n          gl_FragColor = aColor;\n\n        }\n      "),this.u_Scale=t.getUniformLocation(this.program,"u_Scale"),this.u_Offset=t.getUniformLocation(this.program,"u_Offset")},initData:function(t){for(var r,e=this.extent,n=this.grid,o=JSON.parse(JSON.stringify(this.level)),i=this.size,a=1,s=n.features,l=s.length,h=s[0].geometry.coordinates[0],u=1;u<l&&s[u].geometry.coordinates[0]==h;u++)a++;var c=(a-1)*((r=parseInt(l/a))-1)*2,f=new Float32Array(2*l),g=new Float32Array(4*l),v=new Uint16Array(3*c);for(u=0;u<l;u++){var d=s[u].geometry.coordinates,y=s[u].properties.val,m=p(o,y,1);f.set([(d[0]-e[0][0])/i[0]*2-1,1-(d[1]-e[0][1])/i[1]*2],2*u),g.set([m.r/255,m.g/255,m.b/255,m.a],4*u)}for(u=0;u<r-1;u++)for(var w=0;w<a-1;w++){var b=6*(u*(a-1)+w),x=u*a+w,M=x+a,E=x+1,A=M+1;v.set([x,E,A,x,A,M],b)}this.a_Position=P(t,f),this.a_Color=P(t,g);var L=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,L),t.bufferData(t.ELEMENT_ARRAY_BUFFER,v,t.STATIC_DRAW),this.indices=v,this.a_indices=L},setFilter:function(t){for(var r=this.gl,e=JSON.parse(JSON.stringify(this.level)),n=this.grid.features,o=n.length,i=new Float32Array(4*o),a=0;a<e.length;a++)t.indexOf&&-1==t.indexOf(e[a].value)&&(e[a].a=0);for(a=0;a<o;a++){var s=n[a].properties.val,l=p(e,s,1);i.set([l.r/255,l.g/255,l.b/255,l.a],4*a)}this.a_Color=P(r,i)},render:function(t){var r=this.canvas,e=this.size,n=this.gl,o=t.width||400,i=Math.abs(o/e[0]*e[1]);return r.width=o,r.height=i,n.viewport(0,0,o,i),n.uniform2fv(this.u_Scale,[1,1]),n.uniform2fv(this.u_Offset,[0,0]),O.call(this,n,"a_Position",2),O.call(this,n,"a_Color",4),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.a_indices),n.drawElements(n.TRIANGLES,this.indices.length,n.UNSIGNED_SHORT,0),r}};var I=function(t,r,e){if(void 0===e&&(e=1),void 0===r&&(r=0),n=t[r],!isNaN(parseFloat(n))&&isFinite(n))return[t[e],t[r]];for(var n,o=0,i=t.length;o<i;o++)t[o]=I(t[o],r,e);return t},R=function(t){for(var r=u(t),e=0,n=r.features.length;e<n;e++){var o=r.features[e].geometry.coordinates;r.features[e].geometry.coordinates=I(o)}return r},N=function(t){return L.IsoImageCanvasLayer||(L.IsoImageCanvasLayer=L.Canvas.extend({_initContainer:function(){var t=this._container=document.createElement("canvas");this._container.style.opacity=0,L.DomEvent.on(t,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(t,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(t,"mouseout",this._handleMouseOut,this),this._ctx=t.getContext("2d")},_draw:function(){var t,r=this._redrawBounds,e=this._ctx;if(e.save(),r){var n=r.getSize();e.beginPath(),e.rect(r.min.x,r.min.y,n.x,n.y),e.clip()}this._drawing=!0;for(var o=this._drawFirst;o;o=o.next)t=o.layer,(!r||t._pxBounds&&t._pxBounds.intersects(r))&&t._updatePath();this._drawing=!1,e.restore(),this.options.clipLayer&&this.options.clipLayer._clip(e)}})),new L.IsoImageCanvasLayer(t)},j=function(t){return L.ClipCanvasLayer||(L.ClipCanvasLayer=L.Canvas.extend({_initContainer:function(){var t=this._container=document.createElement("canvas");L.DomEvent.on(t,"mousemove",L.Util.throttle(this._onMouseMove,32,this),this),L.DomEvent.on(t,"click dblclick mousedown mouseup contextmenu",this._onClick,this),L.DomEvent.on(t,"mouseout",this._handleMouseOut,this),this._ctx=t.getContext("2d")},_clip:function(t){var r=this._ctx;r.fillStyle=r.createPattern(t.canvas,"no-repeat"),r.beginPath();for(var e=this._drawFirst;e;e=e.next)for(var n=e.layer._parts,o=0,i=n.length;o<i;o++)for(var a=0,s=n[o].length;a<s;a++)r[a?"lineTo":"moveTo"](n[o][a].x,n[o][a].y);r.save(),r.translate(this._bounds.min.x,this._bounds.min.y),r.fill(),r.restore()}})),new L.ClipCanvasLayer(t)};function F(t,r,e,n){if(!t||!e)return!1;for(var o=[],i=n.filter,a=0;t.features[a];a++){var s=t.features[a],l=s.properties.val;if(!(i&&i.indexOf&&-1==i.indexOf(l)||!s.geometry.coordinates.length)){var h=Object.assign({},{stroke:!0,weight:1,opacity:.7,fillOpacity:.7,color:s.properties.color,fillColor:s.properties.color,renderer:e,smoothFactor:.5},n),u=L[r](s.geometry.coordinates,h);o.push(u)}}return o}var q={meters:6371008.8,metres:6371008.8,millimeters:6371008800,millimetres:6371008800,centimeters:637100880,centimetres:637100880,kilometers:6371.0088,kilometres:6371.0088,miles:3958.761333810546,nauticalmiles:6371008.8/1852,inches:6371008.8*39.37,yards:6371008.8/1.0936,feet:20902260.511392,radians:1,degrees:6371008.8/111325};function G(t,r,e){if(!Y(e=e||{}))throw new Error("options is invalid");var n=e.bbox,o=e.id;if(void 0===t)throw new Error("geometry is required");if(r&&r.constructor!==Object)throw new Error("properties must be an Object");n&&X(n),o&&H(o);var i={type:"Feature"};return o&&(i.id=o),n&&(i.bbox=n),i.properties=r||{},i.geometry=t,i}function U(t,r,e){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!V(t[0])||!V(t[1]))throw new Error("coordinates must contain numbers");return G({type:"Point",coordinates:t},r,e)}function B(t,r,e){if(!t)throw new Error("coordinates is required");if(t.length<2)throw new Error("coordinates must be an array of two or more positions");if(!V(t[0][1])||!V(t[0][1]))throw new Error("coordinates must contain numbers");return G({type:"LineString",coordinates:t},r,e)}function W(t,r){if(!Y(r=r||{}))throw new Error("options is invalid");var e=r.bbox,n=r.id;if(!t)throw new Error("No features passed");if(!Array.isArray(t))throw new Error("features must be an Array");e&&X(e),n&&H(n);var o={type:"FeatureCollection"};return n&&(o.id=n),e&&(o.bbox=e),o.features=t,o}function D(t,r,e){if(!t)throw new Error("coordinates is required");return G({type:"MultiLineString",coordinates:t},r,e)}function J(t){if(null==t)throw new Error("degrees is required");return t%360*Math.PI/180}function V(t){return!isNaN(t)&&null!==t&&!Array.isArray(t)}function Y(t){return!!t&&t.constructor===Object}function X(t){if(!t)throw new Error("bbox is required");if(!Array.isArray(t))throw new Error("bbox must be an Array");if(4!==t.length&&6!==t.length)throw new Error("bbox must be an Array of 4 or 6 numbers");t.forEach(function(t){if(!V(t))throw new Error("bbox must only contain numbers")})}function H(t){if(!t)throw new Error("id is required");if(-1===["string","number"].indexOf(typeof t))throw new Error("id must be a number or a string")}function K(t,r,e){if(null!==t)for(var n,o,i,a,s,l,h,u,c=0,f=0,p=t.type,g="FeatureCollection"===p,v="Feature"===p,d=g?t.features.length:1,y=0;y<d;y++){s=(u=!!(h=g?t.features[y].geometry:v?t.geometry:t)&&"GeometryCollection"===h.type)?h.geometries.length:1;for(var m=0;m<s;m++){var w=0,b=0;if(null!==(a=u?h.geometries[m]:h)){l=a.coordinates;var x=a.type;switch(c=!e||"Polygon"!==x&&"MultiPolygon"!==x?0:1,x){case null:break;case"Point":r(l,f,y,w,b),f++,w++;break;case"LineString":case"MultiPoint":for(n=0;n<l.length;n++)r(l[n],f,y,w,b),f++,"MultiPoint"===x&&w++;"LineString"===x&&w++;break;case"Polygon":case"MultiLineString":for(n=0;n<l.length;n++){for(o=0;o<l[n].length-c;o++)r(l[n][o],f,y,w,b),f++;"MultiLineString"===x&&w++,"Polygon"===x&&b++}"Polygon"===x&&w++;break;case"MultiPolygon":for(n=0;n<l.length;n++){for("MultiPolygon"===x&&(b=0),o=0;o<l[n].length;o++){for(i=0;i<l[n][o].length-c;i++)r(l[n][o][i],f,y,w,b),f++;b++}w++}break;case"GeometryCollection":for(n=0;n<a.geometries.length;n++)K(a.geometries[n],r,e);break;default:throw new Error("Unknown Geometry Type")}}}}}function Q(t){var r=[1/0,1/0,-1/0,-1/0];return K(t,function(t){r[0]>t[0]&&(r[0]=t[0]),r[1]>t[1]&&(r[1]=t[1]),r[2]<t[0]&&(r[2]=t[0]),r[3]<t[1]&&(r[3]=t[1])}),r}function Z(t){if(!t)throw new Error("obj is required");var r=$(t);if(r.length>1&&V(r[0])&&V(r[1]))return r;throw new Error("Coordinate is not a valid Point")}function $(t){if(!t)throw new Error("obj is required");var r;if(t.length?r=t:t.coordinates?r=t.coordinates:t.geometry&&t.geometry.coordinates&&(r=t.geometry.coordinates),r)return function t(r){if(r.length>1&&V(r[0])&&V(r[1]))return!0;if(Array.isArray(r[0])&&r[0].length)return t(r[0]);throw new Error("coordinates must only contain numbers")}(r),r;throw new Error("No valid coordinates")}function tt(t,r,e){if(!t)throw new Error("No featureCollection passed");if(!e)throw new Error(".collectionOf() requires a name");if(!t||"FeatureCollection"!==t.type)throw new Error("Invalid input to "+e+", FeatureCollection required");for(var n=0;n<t.features.length;n++){var o=t.features[n];if(!o||"Feature"!==o.type||!o.geometry)throw new Error("Invalid input to "+e+", Feature with geometry required");if(!o.geometry||o.geometry.type!==r)throw new Error("Invalid input to "+e+": must be a "+r+", given "+o.geometry.type)}}function rt(t){if(!t)throw new Error("geojson is required");if(void 0!==t.geometry)return t.geometry;if(t.coordinates||t.geometries)return t;throw new Error("geojson must be a valid Feature or Geometry Object")}function et(t,r){if(!t)throw new Error((r||"geojson")+" is required");if(t.geometry&&t.geometry.type)return t.geometry.type;if(t.type)return t.type;throw new Error((r||"geojson")+" is invalid")}function nt(t,r,e){var n=(e=e||{}).ignoreEndVertices;if(!Y(e))throw new Error("invalid options");if(!t)throw new Error("pt is required");if(!r)throw new Error("line is required");for(var o=Z(t),i=$(r),a=0;a<i.length-1;a++){var s=!1;if(n&&(0===a&&(s="start"),a===i.length-2&&(s="end"),0===a&&a+1===i.length-1&&(s="both")),ot(i[a],i[a+1],o,s))return!0}return!1}function ot(t,r,e,n){var o=e[0],i=e[1],a=t[0],s=t[1],l=r[0],h=r[1],u=l-a,c=h-s;return 0==(e[0]-a)*c-(e[1]-s)*u&&(n?"start"===n?Math.abs(u)>=Math.abs(c)?u>0?a<o&&o<=l:l<=o&&o<a:c>0?s<i&&i<=h:h<=i&&i<s:"end"===n?Math.abs(u)>=Math.abs(c)?u>0?a<=o&&o<l:l<o&&o<=a:c>0?s<=i&&i<h:h<i&&i<=s:"both"===n?Math.abs(u)>=Math.abs(c)?u>0?a<o&&o<l:l<o&&o<a:c>0?s<i&&i<h:h<i&&i<s:void 0:Math.abs(u)>=Math.abs(c)?u>0?a<=o&&o<=l:l<=o&&o<=a:c>0?s<=i&&i<=h:h<=i&&i<=s)}function it(t,r,e){if("object"!=typeof(e=e||{}))throw new Error("options is invalid");var n=e.ignoreBoundary;if(!t)throw new Error("point is required");if(!r)throw new Error("polygon is required");var o=Z(t),i=$(r),a=r.geometry?r.geometry.type:r.type,s=r.bbox;if(s&&!1===function(t,r){return r[0]<=t[0]&&r[1]<=t[1]&&r[2]>=t[0]&&r[3]>=t[1]}(o,s))return!1;"Polygon"===a&&(i=[i]);for(var l=0,h=!1;l<i.length&&!h;l++)if(at(o,i[l][0],n)){for(var u=!1,c=1;c<i[l].length&&!u;)at(o,i[l][c],!n)&&(u=!0),c++;u||(h=!0)}return h}function at(t,r,e){var n=!1;r[0][0]===r[r.length-1][0]&&r[0][1]===r[r.length-1][1]&&(r=r.slice(0,r.length-1));for(var o=0,i=r.length-1;o<r.length;i=o++){var a=r[o][0],s=r[o][1],l=r[i][0],h=r[i][1];if(t[1]*(a-l)+s*(l-t[0])+h*(t[0]-a)==0&&(a-t[0])*(l-t[0])<=0&&(s-t[1])*(h-t[1])<=0)return!e;s>t[1]!=h>t[1]&&t[0]<(l-a)*(t[1]-s)/(h-s)+a&&(n=!n)}return n}function st(t,r){var e=et(t),n=et(r),o=rt(t),i=rt(r);switch(e){case"Point":switch(n){case"MultiPoint":return function(t,r){var e,n=!1;for(e=0;e<r.coordinates.length;e++)if(ht(r.coordinates[e],t.coordinates)){n=!0;break}return n}(o,i);case"LineString":return nt(o,i,{ignoreEndVertices:!0});case"Polygon":return it(o,i,{ignoreBoundary:!0});default:throw new Error("feature2 "+n+" geometry not supported")}case"MultiPoint":switch(n){case"MultiPoint":return function(t,r){for(var e=0;e<t.coordinates.length;e++){for(var n=!1,o=0;o<r.coordinates.length;o++)ht(t.coordinates[e],r.coordinates[o])&&(n=!0);if(!n)return!1}return!0}(o,i);case"LineString":return function(t,r){for(var e=!1,n=0;n<t.coordinates.length;n++){if(!nt(t.coordinates[n],r))return!1;e||(e=nt(t.coordinates[n],r,{ignoreEndVertices:!0}))}return e}(o,i);case"Polygon":return function(t,r){for(var e=!0,n=0;n<t.coordinates.length;n++){var o=it(t.coordinates[1],r);if(!o){e=!1;break}o=it(t.coordinates[1],r,{ignoreBoundary:!0})}return e&&o}(o,i);default:throw new Error("feature2 "+n+" geometry not supported")}case"LineString":switch(n){case"LineString":return function(t,r){for(var e=0;e<t.coordinates.length;e++)if(!nt(t.coordinates[e],r))return!1;return!0}(o,i);case"Polygon":return function(t,r){var e=Q(r),n=Q(t);if(!lt(e,n))return!1;for(var o=!1,i=0;i<t.coordinates.length-1;i++){if(!it(t.coordinates[i],r))return!1;if(o||(o=it(t.coordinates[i],r,{ignoreBoundary:!0})),!o){var a=(s=t.coordinates[i],l=t.coordinates[i+1],[(s[0]+l[0])/2,(s[1]+l[1])/2]);o=it(a,r,{ignoreBoundary:!0})}}var s,l;return o}(o,i);default:throw new Error("feature2 "+n+" geometry not supported")}case"Polygon":switch(n){case"Polygon":return function(t,r){var e=Q(t);if(!lt(Q(r),e))return!1;for(var n=0;n<t.coordinates[0].length;n++)if(!it(t.coordinates[0][n],r))return!1;return!0}(o,i);default:throw new Error("feature2 "+n+" geometry not supported")}default:throw new Error("feature1 "+e+" geometry not supported")}}function lt(t,r){return!(t[0]>r[0])&&(!(t[2]<r[2])&&(!(t[1]>r[1])&&!(t[3]<r[3])))}function ht(t,r){return t[0]===r[0]&&t[1]===r[1]}function ut(t,r,e){if(!Y(e=e||{}))throw new Error("options is invalid");var n=e.units,o=Z(t),i=Z(r),a=J(i[1]-o[1]),s=J(i[0]-o[0]),l=J(o[1]),h=J(i[1]),u=Math.pow(Math.sin(a/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(l)*Math.cos(h);return function(t,r){if(null==t)throw new Error("radians is required");if(r&&"string"!=typeof r)throw new Error("units must be a string");var e=q[r||"kilometers"];if(!e)throw new Error(r+" units is invalid");return t*e}(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),n)}var ct={successCallback:null,verbose:!1},ft={};function pt(t,r,e){e=e||{};for(var n=Object.keys(ct),o=0;o<n.length;o++){var i=n[o],a=e[i];a=null!=a?a:ct[i],ft[i]=a}ft.verbose&&console.log("MarchingSquaresJS-isoContours: computing isocontour for "+r);var s=function(t){var r=[],e=0;t.rows,t.cols;return t.cells.forEach(function(n,o){n.forEach(function(n,i){if(void 0!==n&&5!==(f=n).cval&&10!==f.cval&&!vt(n)){var a=function(t,r,e){var n,o,i,a=t.length,s=[],l=[0,0,1,1,0,0,0,0,-1,0,1,1,-1,0,-1,0],h=[0,-1,0,0,1,1,1,1,0,-1,0,0,0,-1,0,0],u=["none","bottom","right","right","top","top","top","top","left","bottom","right","right","left","bottom","left","none"],c=(t[r][e],t[r][e]),f=c.cval,p=yt(c,i=["none","left","bottom","left","right","none","bottom","left","top","top","none","top","right","right","bottom","none"][f]);s.push([e+p[0],r+p[1]]),p=yt(c,i=u[f]),s.push([e+p[0],r+p[1]]),dt(c);for(var g=e+l[f],v=r+h[f],d=f;g>=0&&v>=0&&v<a&&(g!=e||v!=r)&&void 0!==(c=t[v][g]);){if(0===(f=c.cval)||15===f)return{path:s,info:"mergeable"};i=u[f],n=l[f],o=h[f],5!==f&&10!==f||(5===f?c.flipped?-1===h[d]?(i="left",n=-1,o=0):(i="right",n=1,o=0):-1===l[d]&&(i="bottom",n=0,o=-1):10===f&&(c.flipped?-1===l[d]?(i="top",n=0,o=1):(i="bottom",n=0,o=-1):1===h[d]&&(i="left",n=-1,o=0))),p=yt(c,i),s.push([g+p[0],v+p[1]]),dt(c),g+=n,v+=o,d=f}return{path:s,info:"closed"}}(t.cells,o,i),s=!1;if("mergeable"===a.info)for(var l=a.path[a.path.length-1][0],h=a.path[a.path.length-1][1],u=e-1;u>=0;u--)if(Math.abs(r[u][0][0]-l)<=1e-7&&Math.abs(r[u][0][1]-h)<=1e-7){for(var c=a.path.length-2;c>=0;--c)r[u].unshift(a.path[c]);s=!0;break}s||(r[e++]=a.path)}var f})}),r}(function(t,r){for(var e=t.length-1,n=t[0].length-1,o={rows:e,cols:n,cells:[]},i=0;i<e;++i){o.cells[i]=[];for(var a=0;a<n;++a){var s=0,l=t[i+1][a],h=t[i+1][a+1],u=t[i][a+1],c=t[i][a];if(!(isNaN(l)||isNaN(h)||isNaN(u)||isNaN(c))){s|=l>=r?8:0,s|=h>=r?4:0,s|=u>=r?2:0;var f,p,g,v,d=!1;if(5===(s|=c>=r?1:0)||10===s){var y=(l+h+u+c)/4;5===s&&y<r?(s=10,d=!0):10===s&&y<r&&(s=5,d=!0)}if(0!==s&&15!==s)f=p=g=v=.5,1===s?(g=1-gt(r,l,c),p=1-gt(r,u,c)):2===s?(p=gt(r,c,u),v=1-gt(r,h,u)):3===s?(g=1-gt(r,l,c),v=1-gt(r,h,u)):4===s?(f=gt(r,l,h),v=gt(r,u,h)):5===s?(f=gt(r,l,h),v=gt(r,u,h),p=1-gt(r,u,c),g=1-gt(r,l,c)):6===s?(p=gt(r,c,u),f=gt(r,l,h)):7===s?(g=1-gt(r,l,c),f=gt(r,l,h)):8===s?(g=gt(r,c,l),f=1-gt(r,h,l)):9===s?(p=1-gt(r,u,c),f=1-gt(r,h,l)):10===s?(f=1-gt(r,h,l),v=1-gt(r,h,u),p=gt(r,c,u),g=gt(r,c,l)):11===s?(f=1-gt(r,h,l),v=1-gt(r,h,u)):12===s?(g=gt(r,c,l),v=gt(r,u,h)):13===s?(p=1-gt(r,u,c),v=gt(r,u,h)):14===s?(g=gt(r,c,l),p=gt(r,c,u)):console.log("MarchingSquaresJS-isoContours: Illegal cval detected: "+s),o.cells[i][a]={cval:s,flipped:d,top:f,right:v,bottom:p,left:g}}}}return o}(t,r));return"function"==typeof ft.successCallback&&ft.successCallback(s),s}function gt(t,r,e){return(t-r)/(e-r)}function vt(t){return 0===t.cval||15===t.cval}function dt(t){vt(t)||5===t.cval||10===t.cval||(t.cval=15)}function yt(t,r){return"top"===r?[t.top,1]:"bottom"===r?[t.bottom,0]:"right"===r?[1,t.right]:"left"===r?[0,t.left]:void 0}function mt(t,r){if(!Y(r=r||{}))throw new Error("options is invalid");var e=r.zProperty||"elevation",n=r.flip,o=r.flags;tt(t,"Point","input must contain Points");for(var i=function(t,r){var e={};return function(t,r){if("Feature"===t.type)r(t,0);else if("FeatureCollection"===t.type)for(var e=0;e<t.features.length;e++)r(t.features[e],e)}(t,function(t){var r=$(t)[1];e[r]||(e[r]=[]),e[r].push(t)}),Object.keys(e).map(function(t){return e[t].sort(function(t,r){return $(t)[0]-$(r)[0]})}).sort(function(t,e){return r?$(t[0])[1]-$(e[0])[1]:$(e[0])[1]-$(t[0])[1]})}(t,n),a=[],s=0;s<i.length;s++){for(var l=i[s],h=[],u=0;u<l.length;u++){var c=l[u];c.properties[e]?h.push(c.properties[e]):h.push(0),!0===o&&(c.properties.matrixPosition=[s,u])}a.push(h)}return a}function wt(t,r,e){if(!Y(e=e||{}))throw new Error("options is invalid");var n=e.zProperty||"elevation",o=e.commonProperties||{},i=e.breaksProperties||[];if(tt(t,"Point","Input must contain Points"),!r)throw new Error("breaks is required");if(!Array.isArray(r))throw new Error("breaks must be an Array");if(!Y(o))throw new Error("commonProperties must be an Object");if(!Array.isArray(i))throw new Error("breaksProperties must be an Array");var a=mt(t,{zProperty:n,flip:!0});return W(function(t,r,e){var n=Q(e),o=n[2]-n[0],i=n[3]-n[1],a=n[0],s=n[1],l=r[0].length-1,h=r.length-1,u=o/l,c=i/h,f=function(t){t[0]=t[0]*u+a,t[1]=t[1]*c+s};return t.forEach(function(t){K(t,f)}),t}(function(t,r,e,n,o){for(var i=[],a=1;a<r.length;a++){var s=+r[a],l=Object.assign({},n,o[a]);l[e]=s;var h=D(pt(t,s),l);i.push(h)}return i}(a,r,n,o,i),a,t))}var bt=function(t){this.points=t.points||[],this.duration=t.duration||1e4,this.sharpness=t.sharpness||.85,this.centers=[],this.controls=[],this.stepLength=t.stepLength||60,this.length=this.points.length,this.delay=0;for(var r=0;r<this.length;r++)this.points[r].z=this.points[r].z||0;for(r=0;r<this.length-1;r++){var e=this.points[r],n=this.points[r+1];this.centers.push({x:(e.x+n.x)/2,y:(e.y+n.y)/2,z:(e.z+n.z)/2})}this.controls.push([this.points[0],this.points[0]]);for(r=0;r<this.centers.length-1;r++){e=this.centers[r],n=this.centers[r+1];var o=this.points[r+1].x-(this.centers[r].x+this.centers[r+1].x)/2,i=this.points[r+1].y-(this.centers[r].y+this.centers[r+1].y)/2,a=this.points[r+1].z-(this.centers[r].y+this.centers[r+1].z)/2;this.controls.push([{x:(1-this.sharpness)*this.points[r+1].x+this.sharpness*(this.centers[r].x+o),y:(1-this.sharpness)*this.points[r+1].y+this.sharpness*(this.centers[r].y+i),z:(1-this.sharpness)*this.points[r+1].z+this.sharpness*(this.centers[r].z+a)},{x:(1-this.sharpness)*this.points[r+1].x+this.sharpness*(this.centers[r+1].x+o),y:(1-this.sharpness)*this.points[r+1].y+this.sharpness*(this.centers[r+1].y+i),z:(1-this.sharpness)*this.points[r+1].z+this.sharpness*(this.centers[r+1].z+a)}])}return this.controls.push([this.points[this.length-1],this.points[this.length-1]]),this.steps=this.cacheSteps(this.stepLength),this};function xt(t,r){if(!Y(r=r||{}))throw new Error("options is invalid");var e=r.resolution||1e4,n=r.sharpness||.85;if(!t)throw new Error("line is required");if(!V(e))throw new Error("resolution must be an number");if(!V(n))throw new Error("sharpness must be an number");for(var o=[],i=new bt({points:rt(t).coordinates.map(function(t){return{x:t[0],y:t[1]}}),duration:e,sharpness:n}),a=0;a<i.duration;a+=10){var s=i.pos(a);Math.floor(a/100)%2==0&&o.push([s.x,s.y])}return B(o,t.properties)}bt.prototype.cacheSteps=function(t){var r=[],e=this.pos(0);r.push(0);for(var n=0;n<this.duration;n+=10){var o=this.pos(n);Math.sqrt((o.x-e.x)*(o.x-e.x)+(o.y-e.y)*(o.y-e.y)+(o.z-e.z)*(o.z-e.z))>t&&(r.push(n),e=o)}return r},bt.prototype.vector=function(t){var r=this.pos(t+10),e=this.pos(t-10);return{angle:180*Math.atan2(r.y-e.y,r.x-e.x)/3.14,speed:Math.sqrt((e.x-r.x)*(e.x-r.x)+(e.y-r.y)*(e.y-r.y)+(e.z-r.z)*(e.z-r.z))}},bt.prototype.pos=function(t){var r=t-this.delay;r<0&&(r=0),r>this.duration&&(r=this.duration-1);var e=r/this.duration;if(e>=1)return this.points[this.length-1];var n=Math.floor((this.points.length-1)*e);return function(t,r,e,n,o){var i=function(t){var r=t*t;return[r*t,3*r*(1-t),3*t*(1-t)*(1-t),(1-t)*(1-t)*(1-t)]}(t);return{x:o.x*i[0]+n.x*i[1]+e.x*i[2]+r.x*i[3],y:o.y*i[0]+n.y*i[1]+e.y*i[2]+r.y*i[3],z:o.z*i[0]+n.z*i[1]+e.z*i[2]+r.z*i[3]}}((this.length-1)*e-n,this.points[n],this.controls[n][1],this.controls[n+1][0],this.points[n+1])};var Mt="IsoImage",Et="image/png",At="ActiveXObject"in window,Lt=Math.min,St=Math.max,_t=Math.abs,kt={x:"x",y:"y",v:"v",clipX:"0",clipY:"1"},Ct=function(){var t="L"in window;return t||console.log("未加载leaflet"),t};function Pt(t,r,e){this.name=Mt,this.initialize(t,r,e),this.getIsosurface=function(t,r){if(!this.alow())return!1;var e=T([k.call(this,t)],this.option,t);return r?e:e.toDataURL(Et)},this.getIsoline=function(t,r){if(!this.alow())return!1;var e=T([_.call(this,t)],this.option,t);return r?e:e.toDataURL(Et)},this.getIsoImage=function(t,r){if(!this.alow())return!1;var e=T([k.call(this,t),_.call(this,t)],this.option,t);return r?e:e.toDataURL(Et)},this.getLegend=function(t,r){var e=S(this.option.level||[],t);return!!e&&(r?e:e.toDataURL("image/png"))},this.layer=function(t,r){if(!Ct())return!1;r=Object.assign({},{padding:.5,opacity:.1},r);var e=j(r),n={stroke:!0,weight:1,opacity:.7,fillOpacity:0,color:"#ff0000",fillColor:"#ff0000",renderer:e};return L.polygon(this.option.fmtClip,n).addTo(t),r.clipLayer=e,N(r)},this.getLeafletIsosurface=function(t,r){if(Ct()){var e=F(this.fmtLatlngsIsosurface,"polygon",t,r);return L.featureGroup(e)}},this.getLeafletIsoline=function(t,r){if(!Ct())return!1;var e=F(this.fmtLatlngsIsoline,"polyline",t,r);return L.featureGroup(e)},this.getLeafletIsoImage=function(t,r){if(!Ct())return!1;var e=this.fmtLatlngsIsosurface,n=this.fmtLatlngsIsoline,o=F(e,"polygon",t,r),i=F(n,"polyline",t,r),a=o.concat(i);return L.featureGroup(a)},this.getLeafletLegend=function(t){if(!Ct())return!1;t=Object.assign({},{position:"bottomleft",gradient:!0},t);var r=S(this.option.level||[],t);return!!r&&(t.canvas=r,function(t){return L.Control.IsoLegendCortrol||(L.Control.IsoLegendCortrol=L.Control.extend({options:{position:"bottomleft",canvas:""},initialize:function(t){L.Util.extend(this.options,t)},onAdd:function(){return this._container=L.DomUtil.create("div","leaflet-control-iso-legend"),this._container.appendChild(this.options.canvas),this._container}})),new L.Control.IsoLegendCortrol(t)}(t))}}return Pt.prototype={constructor:Pt,initialize:function(t,r,e){var n=r.extent,o=r.level;if(!n)return console.log("缺少参数extent(画布左上右下坐标)");if(!o)return console.log("缺少参数level(色阶)");o=function(t){for(var r=0,e=t.length;r<e;r++){var n=t[r].color;t[r].r=parseInt(n.substr(1,2),16),t[r].g=parseInt(n.substr(3,2),16),t[r].b=parseInt(n.substr(5,2),16),t[r].a=parseInt(n.substr(7,2)||"ff",16)/255}return t}(o);var i,a,s,h=[Lt(n[0][0],n[1][0]),Lt(n[0][1],n[1][1]),St(n[0][0],n[1][0]),St(n[0][1],n[1][1])],u=[n[1][0]-n[0][0],n[1][1]-n[0][1]],c=r.cellWidth||(i=Math.sqrt(_t(u[0]*u[1]/2e3)),s=(+i).toExponential(a=null==a?1:a),Number(s));At&&(c*=2);var f=Object.assign({},kt,r.keyConfig);this.option={worker:r.worker,type:r.type||"idw",pow:r.pow||3,model:r.model||"spherical",clip:r.clip,fmtClip:r.clip?I(JSON.parse(JSON.stringify(r.clip)),f.clipX,f.clipY):[[h[1],h[0]],[h[3],h[0]],[h[3],h[2]],[h[1],h[2]],[h[1],h[0]]],smooth:r.smooth,ex:n,extent:h,size:u,cellWidth:c,level:o,key:f,webgl:null==r.webgl?1:r.webgl};var p=[],g=[],v=[],d=[];if(l(t))for(var y=0,m=t.length;y<m;y++)if(null!=t[y][f.v]){var w=t[y][f.v],b=t[y][f.x],x=t[y][f.y];p.push({x:b,y:x,v:w}),g.push(w),v.push(b),d.push(x)}this.points=p,this._v=g,this._x=v,this._y=d;var M=this;if(r.worker&&window.Worker&&!At){var E=new Worker(r.worker+"/turf.js");return E.onmessage=function(t){M.pointGrid=t.data,M.calcGridValue(),e&&M.initReady(e)},E.postMessage(["pointGrid",h,c,{units:"degrees"}]),!1}this.pointGrid=function(t,r,e){if(!Y(e=e||{}))throw new Error("options is invalid");var n=e.mask,o=e.properties,i=[];if(null==r)throw new Error("cellSide is required");if(!V(r))throw new Error("cellSide is invalid");if(!t)throw new Error("bbox is required");if(!Array.isArray(t))throw new Error("bbox must be array");if(4!==t.length)throw new Error("bbox must contain 4 numbers");if(n&&-1===["Polygon","MultiPolygon"].indexOf(et(n)))throw new Error("options.mask must be a (Multi)Polygon");for(var a=t[0],s=t[1],l=t[2],h=t[3],u=r/ut([a,s],[l,s],e)*(l-a),c=r/ut([a,s],[a,h],e)*(h-s),f=l-a,p=h-s,g=Math.floor(f/u),v=(p-Math.floor(p/c)*c)/2,d=a+(f-g*u)/2;d<=l;){for(var y=s+v;y<=h;){var m=U([d,y],o);n?st(m,n)&&i.push(m):i.push(m),y+=c}d+=u}return W(i)}(h,c,{units:"degrees"}),this.calcGridValue(),e&&this.initReady(e)},calcGridValue:function(){var t=this.option,r=this.pointGrid,e=this._v,n=this._x,o=this._y,a=t.model;switch(t.type){case"kriging":if(t.worker&&window.Worker&&!At){var s=new Worker(t.worker+"/"+t.type+".js"),l=this;return s.onmessage=function(t){l.pointGrid=t.data,l.pointGridState=!0,l.calcIso()},s.postMessage([r,e,n,o,a,.1,100]),!1}for(var h=i.train(e,n,o,a,.1,100),u=0;u<r.features.length;u++){var c=i.predict(r.features[u].geometry.coordinates[0],r.features[u].geometry.coordinates[1],h);r.features[u].properties.val=c}this.pointGridState=!0,this.calcIso();break;default:var f=this.points;if(t.worker&&window.Worker&&!At){var p=new Worker(t.worker+"/"+t.type+".js");l=this;return p.onmessage=function(t){l.pointGrid=t.data,l.pointGridState=!0,l.calcIso()},p.postMessage([f,r,t.pow]),!1}this.pointGrid=function(t,r,e){null==e&&(e=3);var n=r.features;if(t.length<3)return r;for(var o=t.length,i=n.length,a=[],s=0;s<i;s++)for(var l=0;l<o;l++){var h=Math.sqrt(Math.pow(n[s].geometry.coordinates[0]-t[l].x,2)+Math.pow(n[s].geometry.coordinates[1]-t[l].y,2));a.push(h)}for(s=0;s<i;s++){var u=!1;for(l=o*s;l<o*s+o;l++)if(Math.abs(a[l])<1e-4){n[s].properties.val=t[l-o*s].v,u=!0;break}if(!u){var c=0,f=0;for(l=o*s;l<o*s+o;l++)c+=t[l-o*s].v/Math.pow(a[l],e),f+=1/Math.pow(a[l],e);n[s].properties.val=c/f}}return r}(f,r,t.pow),this.pointGridState=!0,this.calcIso()}},calcIso:function(){for(var t=this.option,r=this.pointGrid,e=t.level,n=[],o=this,i=0,a=e.length;i<a;i++)n.push(e[i].value);if(t.worker&&window.Worker&&!At){var s=new Worker(t.worker+"/turf.js");o=this;return s.onmessage=function(n){var i=n.data;o.isoline=i;var a=function(t){for(var r,e,n,o,i=0,a=t.length;i<a;i++)for(var s=t[i].geometry.coordinates,l=0,h=s.length;l<h;l++){var u=s[l].length;u&&(null==r&&(r=n=s[l][0][0],e=o=s[l][0][1]),r=Math.min(r,s[l][0][0],s[l][u-1][0]),e=Math.min(e,s[l][0][1],s[l][u-1][1]),n=Math.max(n,s[l][0][0],s[l][u-1][0]),o=Math.max(o,s[l][0][1],s[l][u-1][1]))}return[r,e,n,o]}(i.features);try{o.isosurface=b(i,a,r,e)}catch(t){console.log(t)}t.webgl&&(o.isosurfaceWebgl=new z(t.ex,r,e)),t.smooth&&(o.isoline=o.smooth(o.isoline),o.isosurface&&(o.isosurface=o.smooth(o.isosurface))),o.fmtLatlngsIsoline=R(o.isoline),o.isosurface&&(o.fmtLatlngsIsosurface=R(o.isosurface)),o.isoLinesState=!0},s.postMessage(["isolines",r,n,{zProperty:"val"},e]),!1}var l=wt(r,n,{zProperty:"val"}),h=l.features;for(i=0,a=h.length;i<a;i++)for(var u=h[i].properties.val,c=0;e[c];c++)if(e[c].value==u){h[i].properties.color=e[c].color;break}this.isoline=l;try{this.isosurface=b(l,t.extent,r,e)}catch(t){console.log(t)}t.webgl&&(this.isosurfaceWebgl=new z(t.ex,r,e)),t.smooth&&(this.isoline=this.smooth(this.isoline),this.isosurface=this.smooth(this.isosurface)),this.fmtLatlngsIsoline=R(this.isoline),this.fmtLatlngsIsosurface=R(this.isosurface),this.isoLinesState=!0},smooth:function(t){for(var r=t.features,e=0;e<r.length;e++){for(var n=r[e].geometry.coordinates,o=[],i=0;i<n.length;i++){var a=n[i],s=E(a,5);o.push(s)}r[e].geometry.coordinates=o}return t},smooth2:function(t){for(var r=t.features,e=0;e<r.length;e++){for(var n=r[e].geometry.coordinates,o=[],i=0;i<n.length;i++){var a=n[i],s=xt(B(a),{resolution:600*a.length,sharpness:.85,stepLength:1});o.push(s.geometry.coordinates)}r[e].geometry.coordinates=o}return t},alow:function(){return this.pointGrid&&this.isoline},initReady:function(t,r){var e=null,n=this;e=setInterval(function(){n.pointGridState&&n.isoLinesState&&(clearInterval(e),t&&t(n,r))},10)},remove:function(){for(var t in this)delete this[t];return this}},Pt.merge=function(t,r,e){var n=l(t)?t:[],o=Object.assign({},{width:800,height:600,child:[]},r);if(!e||!n.length||!o.child.length)return!1;var i=o.child,a=0,s=o.width,h=o.height,u=document.createElement("canvas");u.width=s,u.height=h;var c=u.getContext("2d");c.clearRect(0,0,s,h);for(var f=0,p=i.length;f<p;f++){var g=i[f],v=n[g.target];v&&(a++,v[g.type]&&v.initReady(function(t,r){var n=t[r.type](r.config,1),o=r.scale||1;a--;var i=c.createPattern(n,"no-repeat");if(c.fillStyle=i,c.save(),c.translate(r.x,r.y),c.scale(o,o),c.fillRect(0,0,n.width,n.height),c.restore(),!a)return e(u)},g))}},Pt});
